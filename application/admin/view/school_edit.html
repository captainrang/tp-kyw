{extend name="base" /}
{block name="body"}
<!--tab标签-->
<style>
    ul,li{
        list-style: none;
    }
</style>
<link rel="stylesheet" type="text/css" href="__ADMIN__/css/formSelects-v4.css"/>
<div class="layui-tab-brief">
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">
            <form class="layui-form form-container" id="layui-form"
                  localtion-url="{:url('admin/school/index')}">

                <div class="layui-form-item">
                    <label class="layui-form-label">学校名称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="name" required lay-verify="required" value="{$school.name}"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>


                <div class="layui-form-item" style="width: 500px">
                    <label class="layui-form-label">学校省份</label>
                    <div class="layui-input-block">
                        <select id="proid">
                            <option value="" ></option>
                            {volist name="province" id="vo"}
                            <option value="{$vo.id}"  {if condition="$vo.id eq $school.proid"}selected{/if}>{$vo.name}
                            </option>
                            {/volist}
                        </select>
                    </div>
                </div>

                <div class="layui-form-item" style="width: 500px">
                    <label class="layui-form-label">学校类型</label>
                    <div class="layui-input-block">
                        <select name="type" id="type" xm-select="sel-type">
                            {volist name="type" id="vo"}
                            <option value="{$vo.id}">{$vo.name}
                            </option>
                            {/volist}
                        </select>
                    </div>
                </div>

                <div class="layui-form-item" style="width: 500px">
                    <label class="layui-form-label">学校属性</label>
                    <div class="layui-input-block">
                        <select name="prop" id="prop" xm-select="sel-prop">
                            {volist name="prop" id="vo"}
                            <option value="{$vo.id}">{$vo.name}
                            </option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item" style="width: 500px">
                    <label class="layui-form-label">学校隶属</label>
                    <div class="layui-input-block">
                        <select name="belong" id="belong" xm-select="sel-belong">
                            {volist name="belong" id="vo"}
                            <option value="{$vo.id}">{$vo.name}
                            </option>
                            {/volist}
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">院校代码</label>
                    <div class="layui-input-block">
                        <input type="text" name="code" required lay-verify="required" placeholder="必填内容"
                               autocomplete="off" class="layui-input" value="{$school.code}">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">学校邮箱</label>
                    <div class="layui-input-block">
                        <input type="text" name="email" required lay-verify="required" placeholder="必填内容" value="{$school.email}"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">学校地址</label>
                    <div class="layui-input-block">
                        <input type="text" name="address" required lay-verify="required" placeholder="必填内容" value="{$school.address}"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">学校电话</label>
                    <div class="layui-input-block">
                        <input type="text" name="tel" required lay-verify="required" placeholder="必填内容" value="{$school.tel}"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">学校网址</label>
                    <div class="layui-input-block">
                        <input type="text" name="website" required lay-verify="required" placeholder="必填内容" value="{$school.website}"
                               autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">学校图片</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="pic">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <input type="text" name="pic" class="layui-input" value="{$school.pic}"
                               style="position: absolute;left: 111px;top: 0px;width: 500px;" lay-verify="required">
                    </div>
                </div>
                <div class="layui-form-item" id="pre-pic"  >
                    <label class="layui-form-label">图片预览</label>
                    <img id="uploaded-pic" width="700px"  src="__ROOT__{$school.pic}" >
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">校徽</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="badge">
                            <i class="layui-icon">&#xe67c;</i>上传图片
                        </button>
                        <input type="text" name="badge" class="layui-input" value="{$school.badge}"
                               style="position: absolute;left: 111px;top: 0px;width: 500px;" lay-verify="required">
                    </div>
                </div>
                <div class="layui-form-item" id="pre-badge"  >
                    <label class="layui-form-label">图片预览</label>
                    <img id="uploaded-badge"  width="150px"   src="__ROOT__{$school.badge}" >
                </div>
                <div class="layui-form-item xs-bolck">
                    <label class="layui-form-label">学校专业</label>
                    <div class="layui-input-inline">
                        <button type="button" class="layui-btn" id="glzy">管理专业
                        </button>
                    </div>
                </div>
                <div class="layui-form-item xs-bolck"  >
                    <label class="layui-form-label">学校专业数据</label>
                    <div class="layui-input-block">
                        <ul>
                            {volist name="m" id="vo"}
                            <li> <span>专业:{$vo.mname} &nbsp;  &nbsp;所在院系:{$vo.colllege} </span></li>
                            {/volist}
                        </ul>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">学校介绍</label>
                    <div class="layui-input-block">
                        <textarea id="info" name="info">{$school.info}</textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">招生简章</label>
                    <div class="layui-input-block">
                        <textarea id="rule" name="rule">{$school.rule}</textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">分数线</label>
                    <div class="layui-input-block">
                        <textarea id="grade" name="grade">{$school.grade}</textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">复试信息</label>
                    <div class="layui-input-block">
                        <textarea id="fushi" name="fushi">{$school.fushi}</textarea>
                    </div>
                </div>
                <div class="btable-paged">
                    <div class="layui-main">
                        <div class="formbtngroup">
                            <button class="layui-btn layui-btn-small" lay-submit="" lay-filter="formadd">更新</button>
                            <button onclick="history.go(-1);" class="layui-btn layui-btn-primary layui-btn-small">返回
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{/block}

{block name="js"}
<script src="__ADMIN__/js/jquery-1.9.1.min.js"></script>
<script src="__ADMIN__/js/common.js"></script>
<script src="__ADMIN__/js/jquery-form.js"></script>
<script src="__ADMIN__/js/formSelects-v4.js"></script>
<script type="text/javascript" src="__ADMIN__/plugins/tinymce/tinymce.min.js"></script>
{/block}
{block name="script"}
<script>


    layui.use(['layer', 'form', 'element', 'upload'], function () {
        var formSelects = layui.formSelects;
        futext('#info');
        futext('#rule');
        futext('#grade');
        futext('#fushi');


        var form = layui.form
            , $ = layui.jquery
            , upload = layui.upload
            , element = layui.element;

        $('#glzy').click(function () {
            var index = layer.open({
                title: ['管理专业', 'font-size:16px'],
                type: 2,
                shadeClose: true,
                shade: false,
                maxmin: true, //开启最大化最小化按钮,
                closeBtn: 2,
                skin: 'layui-layer-rim', //加上边框
                area: ['820px', '500px'], //宽高
                content:  "{:url('admin/school/magor')}?sid={$school.id}" ,
                success:function(){
                    $('#glzy').attr('disabled','disabled' )
                },
                end:function(){
                    $('#glzy').removeAttr('disabled')
                    // location.reload();
                }
            })
        })
var  types,props,belongs;
        var propv="{$school.prop}";
        var typev="{$school.type}";
        var belongv="{$school.belong}";
        if (propv!=''){
            props=propv.split(',');
        } else {
            props=new Array();
        }
        if (typev!=''){
            types=typev.split(',');
        } else{
            types=new Array();
        }
        if (belongv!=''){
            belongs=belongv.split(',');
        } else{
            belongs=new Array();
        }
        formSelects.value('sel-prop', props);
        formSelects.value('sel-type', types);
        formSelects.value('sel-belong', belongs);
        //刷新界面 所有元素 ('school.info}');
        form.render();
        form.on('submit', function (data) {
            var activeEditor0 = tinymce.editors[0];;
            var editBody0 = activeEditor0.getBody();
            activeEditor0.selection.select(editBody0);
            var text0 = activeEditor0.selection.getContent({'format': 'text'});

            var activeEditor1 = tinymce.editors[1];;
            var editBody1 = activeEditor1.getBody();
            activeEditor1.selection.select(editBody1);
            var text1 = activeEditor1.selection.getContent({'format': 'text'});

            var activeEditor2 = tinymce.editors[2];;
            var editBody2 = activeEditor2.getBody();
            activeEditor2.selection.select(editBody2);
            var text2 = activeEditor2.selection.getContent({'format': 'text'});

            var activeEditor3 = tinymce.editors[3];;
            var editBody3= activeEditor3.getBody();
            activeEditor3.selection.select(editBody3);
            var text3= activeEditor3.selection.getContent({'format': 'text'});




            // console.log(text);
            var prop = formSelects.value('sel-prop', 'name');
            var type = formSelects.value('sel-type', 'name');
            var belong = formSelects.value('sel-belong', 'name');

            if (text0.trim() == '' ||text1.trim() == ''||text2.trim() == ''||text3.trim() == ''  || prop.length == 0 || type.length == 0 || belong.length == 0) {
                layer.msg('请输入必填项！', {icon: 2, time: 1000});
            } else {
                var formdata = {
                    'data': JSON.stringify({
                        'name': $('input[name=name]').val()
                        , 'prop': prop.join(',')
                        , 'type': type.join(',')
                        , 'belong': belong.join(',')
                        , 'proid': $('#proid').val()
                        , 'pic': $('input[name=pic]').val()
                        , 'badge': $('input[name=badge]').val()
                        , 'website': $('input[name=website]').val()
                        , 'tel': $('input[name=tel]').val()
                        , 'address': $('input[name=address]').val()
                        , 'email': $('input[name=email]').val()
                        , 'code': $('input[name=code]').val()
                        , 'info': tinyMCE.editors[0].getContent()
                        , 'rule': tinyMCE.editors[1].getContent()
                        , 'grade': tinyMCE.editors[2].getContent()
                        , 'fushi': tinyMCE.editors[3].getContent()
                        , 'id':'{$school.id}'
                    })
                }
                console.log($('#proid').val())
                ajaxform(formdata, " {:url('admin/school/update')} ", $, function () {
                    window.location.href="{:url('admin/school/index')} ";

                    // $('input[name=name]').val('');
                    // $('#proid').val(1);
                    // tinyMCE.activeEditor.setContent('');
                    // formSelects.value('sel-prop', []);
                    // formSelects.value('sel-type', []);
                    // formSelects.value('sel-belong', []);
                    // $('input[name=pic]').val('');
                    // $('input[name=badge]').val('');
                    // $('input[name=website]').val('');
                    // $('input[name=tel]').val('');
                    // $('input[name=address]').val('');
                    // $('input[name=email]').val('');
                    // $("#pre-badge").css('display','none');
                    // $("#pre-pic").css('display','none');
                })


            }
            return false;
        });


        upload.render({
            url: '{:url("upload/upimage")}'
            , elem: '#badge'
            , ext: 'jpg|png|gif'
            , before: function (input) {
                loading = layer.load(2, {
                    shade: [0.2, '#000']
                });
            }
            , done: function (res) {
                layer.close(loading);
                $('input[name=badge]').val(res.path);
                layer.msg(res.msg, {icon: 1, time: 1000});
                $("#pre-badge").css('display','block');
                $('#uploaded-badge').attr('src',getRootPath_web()+res.path);
            }, error: function () {
                layer.close(index);
                layer.msg('上传出错：1', {
                    title: '提示'
                    //不自动关闭
                    , time: 1000
                    , icon: 5
                    , offset: '400px'
                });
            }
        });
        upload.render({
            url: '{:url("upload/upimage")}'
            , elem: '#pic'
            , ext: 'jpg|png|gif'
            , before: function (input) {
                loading = layer.load(2, {
                    shade: [0.2, '#000']
                });
            }
            , done: function (res) {
                layer.close(loading);
                $('input[name=pic]').val(res.path);
                layer.msg(res.msg, {icon: 1, time: 1000});
                $("#pre-pic").css('display','block');
                $('#uploaded-pic').attr('src',getRootPath_web()+res.path);
            }, error: function () {
                layer.close(index);
                layer.msg('上传出错：1', {
                    title: '提示'
                    //不自动关闭
                    , time: 1000
                    , icon: 5
                    , offset: '400px'
                });
            }
        });
    });

</script>
{/block}